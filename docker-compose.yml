version: '3.8'

services:
  # PostgreSQL - Consciousness state storage
  postgres:
    image: postgres:16-alpine
    container_name: feeling-machine-postgres
    restart: always
    networks:
      - traefik_net
      - consciousness-internal
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-consciousness_db}
      POSTGRES_USER: ${POSTGRES_USER:-consciousness}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
      - ./database/schemas:/docker-entrypoint-initdb.d/schemas
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-consciousness}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j - Relationship patterns and graph data
  neo4j:
    image: neo4j:5-community
    container_name: feeling-machine-neo4j
    restart: always
    networks:
      - traefik_net
      - consciousness-internal
    ports:
      - "127.0.0.1:7474:7474"  # HTTP
      - "127.0.0.1:7687:7687"  # Bolt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.neo4j.rule=Host(`${NEO4J_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.neo4j.entrypoints=web,websecure"
      - "traefik.http.routers.neo4j.tls=true"
      - "traefik.http.routers.neo4j.tls.certresolver=mytlschallenge"
      - "traefik.http.services.neo4j.loadbalancer.server.port=7474"
      - "traefik.docker.network=traefik_net"
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD} 'RETURN 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ChromaDB - Emotional memory vectors
  chromadb:
    image: chromadb/chroma:latest
    container_name: feeling-machine-chromadb
    restart: always
    networks:
      - traefik_net
      - consciousness-internal
    ports:
      - "127.0.0.1:8001:8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chromadb.rule=Host(`${CHROMA_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.chromadb.entrypoints=web,websecure"
      - "traefik.http.routers.chromadb.tls=true"
      - "traefik.http.routers.chromadb.tls.certresolver=mytlschallenge"
      - "traefik.http.services.chromadb.loadbalancer.server.port=8000"
      - "traefik.docker.network=traefik_net"
    environment:
      IS_PERSISTENT: "TRUE"
      ANONYMIZED_TELEMETRY: "FALSE"
      ALLOW_RESET: "TRUE"
      CHROMA_SERVER_AUTH_PROVIDER: ${CHROMA_AUTH_PROVIDER:-chromadb.auth.token.TokenAuthServerProvider}
      CHROMA_SERVER_AUTH_CREDENTIALS_PROVIDER: ${CHROMA_AUTH_CREDENTIALS_PROVIDER:-chromadb.auth.token.TokenConfigServerAuthCredentialsProvider}
      CHROMA_SERVER_AUTH_CREDENTIALS: ${CHROMA_AUTH_TOKEN}
      CHROMA_SERVER_AUTH_TOKEN_TRANSPORT_HEADER: ${CHROMA_AUTH_HEADER:-X-Chroma-Token}
    volumes:
      - chromadb_data:/chroma/chroma
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3

  # The Feeling Machine API (Python FastAPI application)
  feeling-machine-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: feeling-machine-api
    restart: always
    networks:
      - traefik_net
      - consciousness-internal
    ports:
      - "127.0.0.1:8000:8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.feeling-machine.rule=Host(`${SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.feeling-machine.entrypoints=web,websecure"
      - "traefik.http.routers.feeling-machine.tls=true"
      - "traefik.http.routers.feeling-machine.tls.certresolver=mytlschallenge"
      - "traefik.http.services.feeling-machine.loadbalancer.server.port=8000"
      - "traefik.docker.network=traefik_net"
    environment:
      # Application
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-consciousness_db}
      POSTGRES_USER: ${POSTGRES_USER:-consciousness}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      
      # Neo4j
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      
      # ChromaDB
      CHROMA_HOST: chromadb
      CHROMA_PORT: 8000
      CHROMA_AUTH_TOKEN: ${CHROMA_AUTH_TOKEN}
      
      # LLM API (Grok)
      GROK_API_KEY: ${GROK_API_KEY}
      GROK_API_BASE_URL: ${GROK_API_BASE_URL:-https://api.x.ai/v1}
      GROK_MODEL: ${GROK_MODEL:-grok-beta}
      
      # Application settings
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE:-UTC}
      MAX_CONSCIOUSNESS_HISTORY: ${MAX_CONSCIOUSNESS_HISTORY:-1000}
      PATTERN_DISCOVERY_THRESHOLD: ${PATTERN_DISCOVERY_THRESHOLD:-0.85}
      
    volumes:
      - ./core:/app/core
      - ./llm:/app/llm
      - ./storage:/app/storage
      - ./interface:/app/interface
      - feeling_machine_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

networks:
  traefik_net:
    external: true
  consciousness-internal:
    driver: bridge
    internal: true

volumes:
  postgres_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
  chromadb_data:
    driver: local
  feeling_machine_logs:
    driver: local
